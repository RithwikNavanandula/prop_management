{% extends "base.html" %}
{% set active_page = "dashboard" %}
{% block title %}Dashboard â€” {{ settings.APP_NAME }}{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Dashboard will render different views based on user role -->
<div id="dashboardContainer">
    <div style="text-align:center;padding:40px;color:var(--text-secondary)">Loading dashboard...</div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let userRole = '{{ role.role_name if role else "Admin" }}';

    async function loadDashboard() {
        const container = document.getElementById('dashboardContainer');
        const roleName = userRole.toLowerCase();

        if (['admin', 'manager', 'super_admin'].includes(roleName)) {
            await renderAdminDashboard(container);
        } else if (roleName === 'owner') {
            await renderOwnerDashboard(container);
        } else if (roleName === 'tenant') {
            await renderTenantDashboard(container);
        } else if (roleName === 'vendor') {
            await renderVendorDashboard(container);
        } else if (roleName === 'accountant') {
            await renderAccountantDashboard(container);
        } else {
            await renderAdminDashboard(container);
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMIN / MANAGER DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function renderAdminDashboard(container) {
        container.innerHTML = `
            <div class="stats-grid" id="adminStats"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px">
                <div class="card" style="padding:20px"><h4>Revenue Trend</h4><canvas id="revenueChart"></canvas></div>
                <div class="card" style="padding:20px"><h4>Maintenance by Status</h4><canvas id="maintChart"></canvas></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">
                <div class="card" style="padding:20px"><h4>Occupancy Overview</h4><canvas id="occChart"></canvas></div>
                <div class="card" style="padding:20px"><h4>Recent Activity</h4><div id="recentActivity" style="max-height:250px;overflow-y:auto"></div></div>
            </div>`;

        try {
            const [portfolio, finance, maint] = await Promise.all([
                apiFetch('/api/dashboard/portfolio').catch(() => ({})),
                apiFetch('/api/dashboard/finance').catch(() => ({})),
                apiFetch('/api/dashboard/maintenance').catch(() => ({}))
            ]);

            // Stats cards
            document.getElementById('adminStats').innerHTML = `
                ${statCard('ğŸ¢', 'Properties', portfolio.total_properties || 0, 'var(--accent-primary)')}
                ${statCard('ğŸ ', 'Total Units', portfolio.total_units || 0, 'var(--accent-success)')}
                ${statCard('ğŸ“Š', 'Occupancy', (portfolio.occupancy_rate || 0) + '%', '#f59e0b')}
                ${statCard('ğŸ’°', 'Revenue', '$' + formatNum(finance.total_revenue || 0), 'var(--accent-primary)')}
                ${statCard('ğŸ”§', 'Open Requests', maint.open_requests || 0, 'var(--accent-danger)')}
                ${statCard('âš¡', 'SLA Breaches', maint.sla_breaches || 0, '#ef4444')}`;

            // Revenue chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: (finance.monthly_labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']),
                    datasets: [{
                        label: 'Revenue', data: finance.monthly_revenue || [0, 0, 0, 0, 0, 0],
                        borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // Maintenance chart
            const maintCtx = document.getElementById('maintChart').getContext('2d');
            new Chart(maintCtx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'In Progress', 'Completed', 'Escalated'],
                    datasets: [{
                        data: [maint.new || 0, maint.in_progress || 0, maint.completed || 0, maint.escalated || 0],
                        backgroundColor: ['#6366f1', '#f59e0b', '#10b981', '#ef4444']
                    }]
                },
                options: { responsive: true }
            });

            // Occupancy chart
            const occCtx = document.getElementById('occChart').getContext('2d');
            new Chart(occCtx, {
                type: 'bar',
                data: {
                    labels: portfolio.property_names || ['Prop A', 'Prop B'],
                    datasets: [{ label: 'Occupied', data: portfolio.occupied_units || [0], backgroundColor: '#10b981' },
                    { label: 'Vacant', data: portfolio.vacant_units || [0], backgroundColor: '#e5e7eb' }]
                },
                options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true } } }
            });

        } catch (e) { console.error('Dashboard error', e); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• OWNER DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function renderOwnerDashboard(container) {
        container.innerHTML = `
            <div class="stats-grid" id="ownerStats"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px">
                <div class="card" style="padding:20px"><h4>My Properties Revenue</h4><canvas id="ownerRevChart"></canvas></div>
                <div class="card" style="padding:20px"><h4>My Maintenance Requests</h4><div id="ownerMaintList" style="max-height:300px;overflow-y:auto"></div></div>
            </div>`;

        try {
            const data = await apiFetch('/api/dashboard/owner').catch(() => ({}));
            document.getElementById('ownerStats').innerHTML = `
                ${statCard('ğŸ¢', 'My Properties', data.total_properties || 0, 'var(--accent-primary)')}
                ${statCard('ğŸ ', 'My Units', data.total_units || 0, 'var(--accent-success)')}
                ${statCard('ğŸ“Š', 'Occupancy', (data.occupancy_rate || 0) + '%', '#f59e0b')}
                ${statCard('ğŸ’°', 'Monthly Revenue', '$' + formatNum(data.monthly_revenue || 0), '#10b981')}`;

            const ctx = document.getElementById('ownerRevChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.property_names || [], datasets: [{
                        label: 'Revenue', data: data.property_revenues || [], backgroundColor: '#6366f1'
                    }]
                },
                options: { responsive: true }
            });

            const maintDiv = document.getElementById('ownerMaintList');
            const requests = data.recent_requests || [];
            maintDiv.innerHTML = requests.length ? requests.map(r =>
                `<div style="padding:8px 0;border-bottom:1px solid var(--border-color)">
                    <strong>${r.request_number || '#' + r.id}</strong> â€” ${r.category || 'General'}
                    <span class="badge badge-${r.status === 'Completed' ? 'success' : 'warning'}" style="float:right">${r.status}</span>
                </div>`).join('') : '<p class="empty-state">No recent requests</p>';
        } catch (e) { console.error(e); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TENANT DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function renderTenantDashboard(container) {
        container.innerHTML = `
            <div class="stats-grid" id="tenantStats"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px">
                <div class="card" style="padding:20px">
                    <h4>My Lease</h4><div id="tenantLease" style="padding:12px 0"></div>
                </div>
                <div class="card" style="padding:20px">
                    <h4>My Maintenance Requests</h4><div id="tenantMaint" style="max-height:300px;overflow-y:auto"></div>
                </div>
            </div>
            <div class="card" style="padding:20px;margin-top:20px">
                <h4>Payment History</h4><div id="tenantPayments" style="max-height:300px;overflow-y:auto"></div>
            </div>`;

        try {
            const [maint, payments] = await Promise.all([
                apiFetch('/api/maintenance/requests?limit=10').catch(() => ({ items: [] })),
                apiFetch('/api/billing/invoices?limit=10').catch(() => ({ items: [] }))
            ]);

            document.getElementById('tenantStats').innerHTML = `
                ${statCard('ğŸ”§', 'Open Requests', (maint.items || []).filter(r => r.status !== 'Completed').length, 'var(--accent-warning)')}
                ${statCard('âœ…', 'Completed', (maint.items || []).filter(r => r.status === 'Completed').length, 'var(--accent-success)')}
                ${statCard('ğŸ“„', 'Pending Bills', (payments.items || []).filter(i => i.status !== 'Paid').length, 'var(--accent-danger)')}`;

            const maintDiv = document.getElementById('tenantMaint');
            maintDiv.innerHTML = (maint.items || []).length ? maint.items.map(r =>
                `<div style="padding:8px 0;border-bottom:1px solid var(--border-color)">
                    <strong>${r.request_number || '#' + r.id}</strong> â€” ${r.category || ''}
                    <span class="badge badge-${r.status === 'Completed' ? 'success' : 'warning'}" style="float:right">${r.status}</span>
                </div>`).join('') : '<p class="empty-state">No requests</p>';

            const payDiv = document.getElementById('tenantPayments');
            payDiv.innerHTML = (payments.items || []).length ? payments.items.map(i =>
                `<div style="padding:8px 0;border-bottom:1px solid var(--border-color)">
                    Invoice #${i.invoice_number || i.id} â€” $${formatNum(i.total_amount || 0)}
                    <span class="badge badge-${i.status === 'Paid' ? 'success' : 'danger'}" style="float:right">${i.status}</span>
                </div>`).join('') : '<p class="empty-state">No invoices</p>';

            document.getElementById('tenantLease').innerHTML = '<p style="color:var(--text-secondary)">Lease info loaded from your profile.</p>';
        } catch (e) { console.error(e); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VENDOR DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function renderVendorDashboard(container) {
        container.innerHTML = `
            <div class="stats-grid" id="vendorStats"></div>
            <div class="card" style="padding:20px;margin-top:24px">
                <h4>My Work Orders</h4>
                <div id="vendorWorkOrders" style="max-height:400px;overflow-y:auto"></div>
            </div>`;

        try {
            const data = await apiFetch('/api/dashboard/vendor').catch(() => ({}));
            document.getElementById('vendorStats').innerHTML = `
                ${statCard('ğŸ“‹', 'Assigned', data.assigned || 0, 'var(--accent-primary)')}
                ${statCard('ğŸ”„', 'In Progress', data.in_progress || 0, '#f59e0b')}
                ${statCard('âœ…', 'Completed', data.completed || 0, 'var(--accent-success)')}
                ${statCard('â­', 'Avg Rating', (data.avg_rating || 0).toFixed(1), '#8b5cf6')}`;

            const woDiv = document.getElementById('vendorWorkOrders');
            const orders = data.work_orders || [];
            woDiv.innerHTML = orders.length ? orders.map(w =>
                `<div style="padding:10px 0;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between">
                    <div><strong>WO-${w.id}</strong> â€” ${w.description || 'Work Order'}</div>
                    <span class="badge badge-${w.status === 'Completed' ? 'success' : w.status === 'InProgress' ? 'warning' : 'info'}">${w.status}</span>
                </div>`).join('') : '<p class="empty-state">No work orders assigned</p>';
        } catch (e) { console.error(e); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACCOUNTANT DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function renderAccountantDashboard(container) {
        container.innerHTML = `
            <div class="stats-grid" id="acctStats"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:24px">
                <div class="card" style="padding:20px"><h4>Revenue vs Expenses</h4><canvas id="acctChart"></canvas></div>
                <div class="card" style="padding:20px"><h4>Invoice Aging</h4><canvas id="agingChart"></canvas></div>
            </div>`;

        try {
            const finance = await apiFetch('/api/dashboard/finance').catch(() => ({}));
            document.getElementById('acctStats').innerHTML = `
                ${statCard('ğŸ’°', 'Total Revenue', '$' + formatNum(finance.total_revenue || 0), 'var(--accent-primary)')}
                ${statCard('ğŸ“‰', 'Total Expenses', '$' + formatNum(finance.total_expenses || 0), 'var(--accent-danger)')}
                ${statCard('ğŸ“Š', 'Net Income', '$' + formatNum((finance.total_revenue || 0) - (finance.total_expenses || 0)), 'var(--accent-success)')}
                ${statCard('ğŸ“„', 'Unpaid Invoices', finance.unpaid_invoices || 0, '#f59e0b')}`;

            const ctx = document.getElementById('acctChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: finance.monthly_labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [
                        { label: 'Revenue', data: finance.monthly_revenue || [0], backgroundColor: '#10b981' },
                        { label: 'Expenses', data: finance.monthly_expenses || [0], backgroundColor: '#ef4444' }
                    ]
                },
                options: { responsive: true }
            });

            const agingCtx = document.getElementById('agingChart').getContext('2d');
            new Chart(agingCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Current', '30 Days', '60 Days', '90+ Days'],
                    datasets: [{
                        data: finance.aging_buckets || [0, 0, 0, 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#f97316', '#ef4444']
                    }]
                },
                options: { responsive: true }
            });
        } catch (e) { console.error(e); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function statCard(icon, label, value, color) {
        return `<div class="stat-card" style="border-left:4px solid ${color}">
            <div class="stat-icon" style="font-size:28px">${icon}</div>
            <div class="stat-details"><div class="stat-value">${value}</div><div class="stat-label">${label}</div></div>
        </div>`;
    }

    function formatNum(n) {
        return Number(n).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    loadDashboard();
</script>
{% endblock %}