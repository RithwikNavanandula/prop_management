{% extends "base.html" %}
{% block title %}Roles & Permissions - {{ settings.APP_NAME }}{% endblock %}
{% block page_title %}Roles & Permissions{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>System Roles</h3>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Role Name</th>
                    <th>Description</th>
                    <th>System</th>
                    <th>Active</th>
                    <th>Permissions</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="roleTableBody">
                <tr>
                    <td colspan="6" class="empty-state">Loading roles...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Permissions Modal -->
<div class="modal-backdrop" id="permModal">
    <div class="modal" style="max-width:700px">
        <div class="modal-header">
            <h3>Edit Permissions: <span id="permRoleName"></span></h3>
            <button class="modal-close" onclick="closeModal('permModal')">√ó</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto">
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px">
                Toggle each permission on/off. Changes take effect when you click Save.
            </p>
            <div id="permToggles" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('permModal')">Cancel</button>
            <button class="btn btn-primary" onclick="savePermissions()">üíæ Save Permissions</button>
        </div>
    </div>
</div>

<style>
    .perm-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--bg-primary);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-color);
    }

    .perm-toggle label {
        font-size: 13px;
        font-weight: 500;
        text-transform: capitalize;
        cursor: pointer;
    }

    .toggle-switch {
        position: relative;
        width: 42px;
        height: 22px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--border-color);
        border-radius: 22px;
        transition: 0.3s;
    }

    .toggle-slider:before {
        content: "";
        position: absolute;
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    .toggle-switch input:checked+.toggle-slider {
        background: var(--accent-primary);
    }

    .toggle-switch input:checked+.toggle-slider:before {
        transform: translateX(20px);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const ALL_PERMISSIONS = [
        'properties', 'leases', 'maintenance', 'work_orders', 'billing', 'payments',
        'tenants', 'owners', 'vendors', 'utilities', 'dashboard', 'reports', 'export',
        'crm', 'marketing', 'compliance', 'workflow', 'automation', 'portfolio',
        'accounting', 'users', 'system', 'admin', 'all'
    ];
    let editingRoleId = null;

    async function loadRoles() {
        try {
            const roles = await apiFetch('/api/auth/roles');
            renderRoles(roles);
        } catch (e) { showToast(e.message, 'error'); }
    }

    function renderRoles(roles) {
        const tbody = document.getElementById('roleTableBody');
        if (!roles.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No roles</td></tr>'; return; }
        tbody.innerHTML = roles.map(r => {
            const perms = r.permissions || {};
            const activePerms = Object.entries(perms).filter(([k, v]) => v === true).map(([k]) => k);
            const permSummary = activePerms.length > 3
                ? activePerms.slice(0, 3).join(', ') + ` +${activePerms.length - 3} more`
                : activePerms.join(', ') || 'None';
            return `
            <tr>
                <td><span class="badge badge-purple">${r.role_name}</span></td>
                <td>${r.description || '-'}</td>
                <td>${r.is_system ? '‚úÖ' : '-'}</td>
                <td><span class="badge badge-${r.is_active ? 'success' : 'secondary'}">${r.is_active ? 'Active' : 'Inactive'}</span></td>
                <td><code style="font-size:11px">${permSummary}</code></td>
                <td>
                    <button class="btn btn-secondary btn-sm" onclick='editPerms(${JSON.stringify(r)})'>üîê Edit Perms</button>
                </td>
            </tr>`;
        }).join('');
    }

    function editPerms(r) {
        editingRoleId = r.id;
        document.getElementById('permRoleName').textContent = r.role_name;
        const perms = r.permissions || {};
        const container = document.getElementById('permToggles');
        container.innerHTML = ALL_PERMISSIONS.map(key => `
            <div class="perm-toggle">
                <label for="perm_${key}">${key.replace(/_/g, ' ')}</label>
                <div class="toggle-switch">
                    <input type="checkbox" id="perm_${key}" data-perm="${key}" ${perms[key] ? 'checked' : ''}>
                    <span class="toggle-slider"></span>
                </div>
            </div>
        `).join('');
        document.getElementById('permModal').classList.add('active');
    }

    async function savePermissions() {
        const perms = {};
        ALL_PERMISSIONS.forEach(key => {
            const el = document.getElementById('perm_' + key);
            if (el) perms[key] = el.checked;
        });
        try {
            await apiFetch(`/api/auth/roles/${editingRoleId}`, {
                method: 'PUT', body: JSON.stringify({ permissions: perms })
            });
            closeModal('permModal');
            showToast('Permissions updated');
            loadRoles();
        } catch (e) { showToast(e.message, 'error'); }
    }

    loadRoles();
</script>
{% endblock %}
